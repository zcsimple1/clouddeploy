# Logstash 配置：接收 EMQX MQTT 消息
# 用途: 接收来自 EMQX 的 MQTT 消息并存储到 Elasticsearch

input {
  # HTTP 输入：接收 EMQX Webhook 消息
  http {
    port => 5000
    codec => json
    tags => ["emqx", "mqtt"]
  }

  # 可选：TCP 输入（如果使用 MQTT 协议）
  tcp {
    port => 5001
    codec => json_lines
    tags => ["emqx-tcp", "mqtt"]
  }
}

filter {
  if "emqx" in [tags] {
    # 解析 MQTT 消息
    mutate {
      add_field => {
        "service" => "emqx"
        "type" => "mqtt_message"
      }
    }

    # 解析时间戳
    if [timestamp] {
      date {
        match => ["timestamp", "UNIX", "ISO8601"]
        target => "@timestamp"
        remove_field => ["timestamp"]
      }
    }

    # 解析 payload（如果是 JSON）
    if [payload] {
      json {
        source => "payload"
        target => "payload_json"
        remove_field => ["payload"]
      }
    }

    # 提取主题信息
    grok {
      match => {
        "topic" => [
          "^(?<root_topic>[^/]+)/(?<product>[^/]+)/(?<device>[^/]+)/(?<category>[^/]+)(/(?<action>[^/]+))?",
          "^(?<root_topic>[^/]+)/(?<product>[^/]+)/(?<device>[^/]+)/(?<category>[^/]+)"
        ]
      }
      remove_field => ["message"]
    }
  }
}

output {
  if "emqx" in [tags] {
    # 输出到 Elasticsearch
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "emqx-mqtt-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }

    # 可选：同时输出到文件进行调试
    file {
      path => "/usr/share/logstash/logs/emqx-messages.log"
      codec => line { format => "%{message}" }
    }
  }
}

# OneNET ç‰©æ¨¡å‹æ¶ˆæ¯æ ¼å¼è§„èŒƒ

## æ ¸å¿ƒæ¦‚å¿µ

**å…³é”®å‘ç°ï¼š**
- âœ“ è®¾å¤‡å‘å¸ƒæ¶ˆæ¯ â†’ å¹³å°å¤„ç† â†’ å¹³å°è¿”å›å“åº”
- âœ“ è®¾å¤‡è®¢é˜…å“åº”ä¸»é¢˜ â†’ æ”¶åˆ°å¹³å°å“åº”
- âœ“ è¿™å°±æ˜¯æ‚¨åœ¨ MQTTX ä¸­çœ‹åˆ°çš„"æ”¶åˆ°è®¢é˜…çš„æ¶ˆæ¯"

---

## æ•°æ®æµå›¾

```
è®¾å¤‡                       OneNET å¹³å°
  â”‚                           â”‚
  â”‚  1. ä¸ŠæŠ¥æ•°æ®               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
  â”‚  thing/property/post        â”‚
  â”‚  thing/event/post          â”‚
  â”‚                           â”‚
  â”‚  2. å¹³å°å¤„ç†               â”‚
  â”‚                           â”œâ”€ éªŒè¯æ ¼å¼
  â”‚                           â”œâ”€ å­˜å‚¨æ•°æ®
  â”‚                           â””â”€ ç”Ÿæˆå“åº”
  â”‚                           â”‚
  â”‚  3. å¹³å°å“åº”               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  thing/property/post/reply â”‚
  â”‚  thing/event/post/reply    â”‚
  â”‚                           â”‚
```

---

## æ¶ˆæ¯æ ¼å¼è§„èŒƒ

### 1. è®¾å¤‡å±æ€§ä¸ŠæŠ¥

**è¯·æ±‚ï¼ˆè®¾å¤‡å‘å¸ƒï¼‰ï¼š**
```json
{
  "id": "1234567890",          // å­—ç¬¦ä¸²ç±»å‹çš„æ¶ˆæ¯ ID
  "version": "1.0",             // åè®®ç‰ˆæœ¬
  "params": {                   // å±æ€§é”®å€¼å¯¹
    "temperature": 25.5,
    "humidity": 60,
    "pressure": 1013.25
  }
}
```

**å“åº”ï¼ˆå¹³å°è¿”å›ï¼‰ï¼š**
```json
{
  "id": "1234567890",          // å¯¹åº”è¯·æ±‚çš„ ID
  "code": 200,                 // 200 è¡¨ç¤ºæˆåŠŸ
  "msg": "success"             // å“åº”æ¶ˆæ¯
}
```

**å¸¸è§é”™è¯¯ç ï¼š**
- `2402` - `request format error`ï¼ˆæ ¼å¼é”™è¯¯ï¼‰
- `2405` - `msg id invalid`ï¼ˆID æ ¼å¼é”™è¯¯ï¼‰

### 2. è®¾å¤‡äº‹ä»¶ä¸ŠæŠ¥

**è¯·æ±‚ï¼ˆè®¾å¤‡å‘å¸ƒï¼‰ï¼š**
```json
{
  "id": "evt_1234567890",
  "version": "1.0",
  "params": {
    "event_name": {            // äº‹ä»¶åç§°
      "value": 100,           // äº‹ä»¶å€¼
      "time": 1704067200      // æ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼‰
    }
  }
}
```

**å“åº”ï¼ˆå¹³å°è¿”å›ï¼‰ï¼š**
```json
{
  "id": "evt_1234567890",
  "code": 200,
  "msg": "success"
}
```

### 3. å¹³å°ä¸‹å‘å±æ€§è®¾ç½®

**è¯·æ±‚ï¼ˆå¹³å°å‘å¸ƒï¼Œè®¾å¤‡è®¢é˜…ï¼‰ï¼š**
```json
{
  "id": "set_1234567890",
  "version": "1.0",
  "params": {
    "temperature": 30.0,
    "humidity": 70
  },
  "method": "thing.service.property.set"
}
```

**å“åº”ï¼ˆè®¾å¤‡å‘å¸ƒï¼‰ï¼š**
```json
{
  "id": "set_1234567890",
  "code": 200,
  "msg": "success"
}
```

### 4. å‘½ä»¤ä¸‹å‘

**è¯·æ±‚ï¼ˆå¹³å°å‘å¸ƒï¼Œè®¾å¤‡è®¢é˜…ï¼‰ï¼š**
```json
{
  "cmdId": "cmd_1234567890",
  "timestamp": 1704067200,
  "params": {
    "command": "reboot",
    "delay": 5
  }
}
```

**å“åº”ï¼ˆè®¾å¤‡å‘å¸ƒï¼‰ï¼š**
```json
{
  "cmdId": "cmd_1234567890",
  "timestamp": 1704067200,
  "code": 0,
  "msg": "success"
}
```

---

## ä¸»é¢˜åˆ—è¡¨

### å±æ€§ç›¸å…³

| åŠŸèƒ½ | ä¸»é¢˜ | æ–¹å‘ |
|------|------|------|
| å±æ€§ä¸ŠæŠ¥ | `$sys/{pid}/{device}/thing/property/post` | è®¾å¤‡â†’å¹³å° |
| å±æ€§ä¸ŠæŠ¥å“åº” | `$sys/{pid}/{device}/thing/property/post/reply` | å¹³å°â†’è®¾å¤‡ |
| å±æ€§è®¾ç½® | `$sys/{pid}/{device}/thing/property/set` | å¹³å°â†’è®¾å¤‡ |
| å±æ€§è®¾ç½®å“åº” | `$sys/{pid}/{device}/thing/property/set_reply` | è®¾å¤‡â†’å¹³å° |
| å±æ€§è·å– | `$sys/{pid}/{device}/thing/property/get` | å¹³å°â†’è®¾å¤‡ |
| å±æ€§è·å–å“åº” | `$sys/{pid}/{device}/thing/property/get_reply` | è®¾å¤‡â†’å¹³å° |

### äº‹ä»¶ç›¸å…³

| åŠŸèƒ½ | ä¸»é¢˜ | æ–¹å‘ |
|------|------|------|
| äº‹ä»¶ä¸ŠæŠ¥ | `$sys/{pid}/{device}/thing/event/post` | è®¾å¤‡â†’å¹³å° |
| äº‹ä»¶ä¸ŠæŠ¥å“åº” | `$sys/{pid}/{device}/thing/event/post/reply` | å¹³å°â†’è®¾å¤‡ |

### æœåŠ¡ç›¸å…³

| åŠŸèƒ½ | ä¸»é¢˜ | æ–¹å‘ |
|------|------|------|
| æœåŠ¡è°ƒç”¨ | `$sys/{pid}/{device}/thing/service/{id}/invoke` | å¹³å°â†’è®¾å¤‡ |
| æœåŠ¡è°ƒç”¨å“åº” | `$sys/{pid}/{device}/thing/service/{id}/invoke_reply` | è®¾å¤‡â†’å¹³å° |

### å‘½ä»¤ç›¸å…³

| åŠŸèƒ½ | ä¸»é¢˜ | æ–¹å‘ |
|------|------|------|
| å‘½ä»¤è¯·æ±‚ | `$sys/{pid}/{device}/cmd/request/+` | å¹³å°â†’è®¾å¤‡ |
| å‘½ä»¤å“åº” | `$sys/{pid}/{device}/cmd/response/{cmdId}` | è®¾å¤‡â†’è®¾å¤‡ |
| å‘½ä»¤æˆåŠŸ | `$sys/{pid}/{device}/cmd/response/+/accepted` | å¹³å°â†’è®¾å¤‡ |
| å‘½ä»¤å¤±è´¥ | `$sys/{pid}/{device}/cmd/response/+/rejected` | å¹³å°â†’è®¾å¤‡ |

---

## ELK MQTT æ¡¥æ¥é…ç½®

### æ¨èé…ç½®ï¼ˆç›‘æ§æ‰€æœ‰é€šä¿¡ï¼‰

```bash
# setup-mqtt.sh

CLIENT_ID="MO1"  # æˆ– MO

# è®¢é˜…æ‰€æœ‰ä¸»é¢˜ï¼ˆåŒ…æ‹¬ä¸ŠæŠ¥å’Œå“åº”ï¼‰
MQTT_TOPICS="\$sys/v6IkuqD6vh/MO1/thing/#
,\$sys/v6IkuqD6vh/MO1/cmd/#
,\$sys/v6IkuqD6vh/MO1/dp/#
,\$sys/v6IkuqD6vh/MO1/image/#
,\$sys/v6IkuqD6vh/MO1/ota/#
,\$sys/v6IkuqD6vh/MO1/custome/#"

# Token
MO1_TOKEN="version=2018-10-31&res=products%2Fv6IkuqD6vh%2Fdevices%2FMO1&et=1772105871&method=sha1&sign=ZZoc17%2BbrxprIZ7prgo82Y%2FTDG4%3D"
```

### é…ç½®è¯´æ˜

è¿™ä¸ªé…ç½®ä¼šæ”¶é›†ï¼š
1. âœ“ **è®¾å¤‡ä¸ŠæŠ¥** - å±æ€§ã€äº‹ä»¶ã€æ•°æ®ç‚¹
2. âœ“ **å¹³å°å“åº”** - ä¸ŠæŠ¥æˆåŠŸçš„ç¡®è®¤
3. âœ“ **å¹³å°ä¸‹å‘** - å±æ€§è®¾ç½®ã€å‘½ä»¤ã€æœåŠ¡è°ƒç”¨
4. âœ“ **è®¾å¤‡å“åº”** - å‘½ä»¤æ‰§è¡Œç»“æœ

### Logstash è¾“å‡ºç¤ºä¾‹

```json
{
  "message": "{\"id\":\"123456\",\"code\":200,\"msg\":\"success\"}",
  "project": "onenet",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "topic": "$sys/v6IkuqD6vh/MO1/thing/property/post/reply",
  "device": "MO1",
  "type": "platform_response",
  "code": 200,
  "status": "success"
}
```

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å®Œæ•´é€šä¿¡

è®¢é˜…æ‰€æœ‰ä¸»é¢˜ï¼š
```python
client.subscribe("$sys/v6IkuqD6vh/MO1/#")
```

### 2. åŒºåˆ†æ¶ˆæ¯ç±»å‹

æ ¹æ®ä¸»é¢˜åç¼€åˆ¤æ–­ï¼š
- `/post` - è®¾å¤‡ä¸ŠæŠ¥
- `/post/reply` - å¹³å°å“åº”
- `/set` - å¹³å°ä¸‹å‘
- `/set_reply` - è®¾å¤‡å“åº”
- `/invoke` - å¹³å°è°ƒç”¨æœåŠ¡
- `/invoke_reply` - è®¾å¤‡å“åº”æœåŠ¡

### 3. ç›‘æ§é”™è¯¯

æ£€æŸ¥å“åº”ä¸­çš„ `code` å­—æ®µï¼š
- `200` - æˆåŠŸ
- `2402` - æ ¼å¼é”™è¯¯
- `2405` - ID æ— æ•ˆ

---

## æ€»ç»“

### âœ… å…³é”®å‘ç°

1. **è®¾å¤‡ä¸ŠæŠ¥æ•°æ® â†’ å¹³å°å¤„ç† â†’ å¹³å°è¿”å›å“åº”**
2. **è®¢é˜…å“åº”ä¸»é¢˜å°±èƒ½æ”¶åˆ°å¹³å°çš„å¤„ç†ç»“æœ**
3. **è¿™å°±æ˜¯ MQTTX æ˜¾ç¤º"æ”¶åˆ°æ¶ˆæ¯"çš„åŸå› **

### ğŸ“‹ å®é™…åº”ç”¨

å¯¹äº ELK MQTT æ¡¥æ¥ï¼š
- âœ“ è®¢é˜…æ‰€æœ‰ä¸»é¢˜
- âœ“ æ•è·å®Œæ•´çš„è®¾å¤‡-å¹³å°é€šä¿¡
- âœ“ åŒ…æ‹¬è®¾å¤‡ä¸ŠæŠ¥ã€å¹³å°å“åº”ã€å¹³å°ä¸‹å‘ã€è®¾å¤‡å“åº”

### ğŸ¯ æ•°æ®ç›‘æ§

é€šè¿‡è®¢é˜…è¿™äº›ä¸»é¢˜ï¼Œå¯ä»¥ç›‘æ§ï¼š
- è®¾å¤‡æ˜¯å¦æ­£å¸¸ä¸ŠæŠ¥
- å¹³å°æ˜¯å¦æ­£å¸¸å“åº”
- æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿ
- è®¾å¤‡ä¸å¹³å°çš„å®Œæ•´äº¤äº’æ—¥å¿—

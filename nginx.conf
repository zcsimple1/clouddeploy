worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    server {
        listen 80;
        server_name localhost;

        # zcgames 项目路由
        location /zcgames/ {
            alias /usr/share/nginx/html/zcgames/;
            index index.html;
            try_files $uri $uri/ /zcgames/index.html;
        }

        # edutool 项目路由
        location /edutool/ {
            alias /usr/share/nginx/html/edutool/;
            index index.html;
            try_files $uri $uri/ /edutool/index.html;
        }

        # webtool 项目路由
        location /webtool/ {
            alias /usr/share/nginx/html/webtool/;
            index index.html;
            try_files $uri $uri/ /webtool/index.html;
        }

        # commonserv FastAPI 后端路由
        location /api/ {
            proxy_pass http://commonserv:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # OneNet HTTP 推送验证
        location /onenet/ {
            if ($arg_msg) {
                return 200 $arg_msg;
            }
            return 200 '';
        }

        # 根路径重定向到选择页面
        location = / {
            default_type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>项目选择</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .button {
            display: inline-block;
            padding: 15px 30px;
            margin: 10px;
            text-decoration: none;
            border-radius: 5px;
            font-size: 18px;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: scale(1.05);
        }
        .btn-zcgames {
            background: #4CAF50;
            color: white;
        }
        .btn-edutool {
            background: #2196F3;
            color: white;
        }
        .btn-webtool {
            background: #FF9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>请选择要访问的项目</h1>
        <a href="/zcgames/" class="button btn-zcgames">ZCGames</a>
        <a href="/edutool/" class="button btn-edutool">EduTool</a>
        <a href="/webtool/" class="button btn-webtool">WebTool</a>
        <a href="/api/" class="button" style="background: #9C27B0; color: white;">CommonServ API</a>
    </div>
</body>
</html>';
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Gzip 压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
    }
}

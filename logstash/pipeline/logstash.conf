input {
  # MQTT 输入 - OneNET 物模型主题（需要安装 logstash-input-mqtt 插件）
  # mqtt {
  #   client_id => "logstash"
  #   host => "mqtts.heclouds.com"
  #   port => 1883
  #   topics => [
  #     "$sys/v6IkuqD6vh/+/thing/#",
  #     "$sys/v6IkuqD6vh/+/cmd/#"
  #   ]
  #   username => "v6IkuqD6vh"
  #   password => "version=2018-10-31&res=products%2Fv6IkuqD6vh&et=1801645916&method=sha1&sign=ED9TjM7IgdCUNJJqJvBjJ2dg8Q0%3D"
  #   codec => json
  #   type => "mqtt"
  # }

  http {
    host => "0.0.0.0"
    port => 5000
    codec => plain
    type => "http"
    response_code => 200
    response_content_type => "application/json"
    response_headers => {
      "Content-Type" => "application/json"
    }
  }

  tcp {
    port => 5044
    codec => json
    type => "tcp"
  }

  udp {
    port => 5044
    codec => json
    type => "udp"
  }

  file {
    path => "/var/log/docker/*.log"
    start_position => "beginning"
    type => "docker"
  }
}

filter {
  # HTTP 请求处理 - OneNet GET 请求
  if [type] == "http" {
    mutate {
      add_field => { "project" => "http" }
    }
    # 解析 OneNet GET 请求中的 msg 参数
    if [url][path] =~ /\?msg=/ {
      grok {
        match => {
          "[url][path]" => [
            ".*&msg=%{DATA:onenet_msg}&.*",
            ".*\\?msg=%{DATA:onenet_msg}&.*",
            ".*msg=%{DATA:onenet_msg}.*"
          ]
        }
      }
      # URL 解码
      ruby {
        code => 'event.set("onenet_msg", event.get("onenet_msg").to_s.unpack("m*").first.unpack("H*").map { |x| x.to_i(16).chr }.join) rescue event.get("onenet_msg")'
      }
    }
  }

  if [type] == "docker" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{GREEDYDATA:message}" }
    }
    date {
      match => [ "timestamp", "ISO8601" ]
    }
  }

  # MQTT 消息处理
  if [type] == "mqtt" {
    mutate {
      add_field => { "project" => "onenet" }
    }
    # 解析 OneNET 物模型主题：$sys/{pid}/{device-name}/{category}/{sub-category}
    if [topic] {
      grok {
        match => {
          "topic" => [
            "\$sys/%{WORD:product_id}/%{WORD:device_name}/%{WORD:category}/%{GREEDYDATA:sub_category}",
            "\$sys/%{WORD:product_id}/%{WORD:device_name}/%{WORD:category}",
            "\$sys/%{WORD:product_id}/%{WORD:device_name}"
          ]
        }
      }
    }
  }

  # 为其他类型添加默认 project 字段
  if [type] == "http" {
    mutate {
      add_field => { "project" => "http" }
      # 如果有 OneNet 消息，覆盖 project
    }
    if [onenet_msg] {
      mutate {
        replace => { "project" => "onenet" }
        add_field => { "message" => "%{onenet_msg}" }
      }
    }
  } else if [type] == "tcp" {
    mutate {
      add_field => { "project" => "tcp" }
    }
  } else if [type] == "udp" {
    mutate {
      add_field => { "project" => "udp" }
    }
  } else if ![project] {
    mutate {
      add_field => { "project" => "unknown" }
    }
  }

  # 提取项目信息（保留 Docker 日志逻辑）
  if [path] =~ "zcgames" and [type] == "docker" {
    mutate {
      add_field => { "project" => "zcgames" }
    }
  } else if [path] =~ "edutool" and [type] == "docker" {
    mutate {
      add_field => { "project" => "edutool" }
    }
  } else if [path] =~ "webtool" and [type] == "docker" {
    mutate {
      add_field => { "project" => "webtool" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{project}-%{+YYYY.MM.dd}"
    action => "create"
  }

  stdout {
    codec => rubydebug
  }
}

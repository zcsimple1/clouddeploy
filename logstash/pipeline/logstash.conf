input {
  # MQTT 输入 - OneNET 物模型主题（需要安装 logstash-input-mqtt 插件）
  # mqtt {
  #   client_id => "logstash"
  #   host => "mqtts.heclouds.com"
  #   port => 1883
  #   topics => [
  #     "$sys/v6IkuqD6vh/+/thing/#",
  #     "$sys/v6IkuqD6vh/+/cmd/#"
  #   ]
  #   username => "v6IkuqD6vh"
  #   password => "version=2018-10-31&res=products%2Fv6IkuqD6vh&et=1801645916&method=sha1&sign=ED9TjM7IgdCUNJJqJvBjJ2dg8Q0%3D"
  #   codec => json
  #   type => "mqtt"
  # }

  # HTTP 输入 - 兼容 OneNet 验证
  http {
    host => "0.0.0.0"
    port => 5000
    codec => plain
    type => "http"
  }

  tcp {
    port => 5044
    codec => json
    type => "tcp"
  }

  udp {
    port => 5044
    codec => json
    type => "udp"
  }

  file {
    path => "/var/log/docker/*.log"
    start_position => "beginning"
    type => "docker"
  }
}

filter {
  # HTTP 请求处理 - OneNet GET 请求
  if [type] == "http" {

    # 检测是否为 OneNet 验证请求（GET 请求包含 msg、nonce、signature 参数）
    if [http][method] == "GET" and [url][path] {
      ruby {
        code => '
          path = event.get("[url][path]")
          if path && path.include?("msg=")
            # 解析查询参数
            params = {}
            path.split("?")[1..-1].each do |param_str|
              param_str.split("&").each do |pair|
                key, value = pair.split("=", 2)
                if key && value
                  # URL 解码
                  require "uri"
                  params[key] = URI.decode_www_form_component(value)
                end
              end
            end if path.include?("?")


            if params["msg"] && params["nonce"] && params["signature"]
              # 这是 OneNet 验证请求，设置响应返回 msg
              event.set("onenet_msg", params["msg"])
              event.set("onenet_nonce", params["nonce"])
              event.set("onenet_signature", params["signature"])

              # 设置 HTTP 响应内容
              event.set("[@metadata][response_code]", 200)
              event.set("[@metadata][response_headers]", {"Content-Type" => "text/plain"})
              event.set("[@metadata][response_body]", params["msg"])

              event.tag("onenet_verify")
            end
          end
        '
      }
    }
  }

  if [type] == "docker" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{GREEDYDATA:message}" }
    }
    date {
      match => [ "timestamp", "ISO8601" ]
    }
  }

  # MQTT 消息处理
  if [type] == "mqtt" {
    mutate {
      add_field => { "project" => "onenet" }
    }
    # 解析 OneNET 物模型主题：$sys/{pid}/{device-name}/{category}/{sub-category}
    if [topic] {
      grok {
        match => {
          "topic" => [
            "\$sys/%{WORD:product_id}/%{WORD:device_name}/%{WORD:category}/%{GREEDYDATA:sub_category}",
            "\$sys/%{WORD:product_id}/%{WORD:device_name}/%{WORD:category}",
            "\$sys/%{WORD:product_id}/%{WORD:device_name}"
          ]
        }
      }
    }
  }

  # 为其他类型添加默认 project 字段
  if [type] == "http" {
    # OneNet POST 请求通过 user_agent 识别（不区分大小写）
    if [user_agent][original] =~ "(?i)onenet" {
      mutate {
        add_field => { "project" => "onenet" }
      }
      # 解析 OneNet msg 字段中的 JSON 数据
      if [msg] {
        json {
          source => "msg"
          target => "onenet_data"
        }
      }
      # 将 onenet_data 的字段提升到顶层
      ruby {
        code => '
          onenet_data = event.get("[onenet_data]")
          if onenet_data
            onenet_data.each do |key, value|
              # 保留原有字段，避免覆盖
              unless event.get(key)
                event.set(key, value)
              end
            end
          end
        '
      }
      # 使用 OneNet 的 time 字段作为 @timestamp（毫秒时间戳转换）
      if [time] {
        ruby {
          code => '
            time_ms = event.get("[time]")
            if time_ms
              time_value = time_ms.is_a?(Integer) ? time_ms : time_ms.to_i
              timestamp = LogStash::Timestamp.at(time_value / 1000.0)
              event.set("@timestamp", timestamp)
            end
          '
        }
      }
      # 提取 data 字段内容到顶层（保留嵌套结构）
      if [data] {
        ruby {
          code => '
            data = event.get("[data]")
            if data
              data.each do |key, value|
                field_name = "data_" + key
                event.set(field_name, value)
              end
            end
          '
        }
      }
    } else if "onenet_verify" in [tags] {
      mutate {
        add_field => { "project" => "onenet_verify" }
      }
    } else {
      mutate {
        add_field => { "project" => "http" }
      }
    }
  } else if [type] == "tcp" {
    mutate {
      add_field => { "project" => "tcp" }
    }
  } else if [type] == "udp" {
    mutate {
      add_field => { "project" => "udp" }
    }
  } else if ![project] {
    mutate {
      add_field => { "project" => "unknown" }
    }
  }

  # 提取项目信息（保留 Docker 日志逻辑）
  if [path] =~ "zcgames" and [type] == "docker" {
    mutate {
      add_field => { "project" => "zcgames" }
    }
  } else if [path] =~ "edutool" and [type] == "docker" {
    mutate {
      add_field => { "project" => "edutool" }
    }
  } else if [path] =~ "webtool" and [type] == "docker" {
    mutate {
      add_field => { "project" => "webtool" }
    }
  }
}

output {
  # OneNet 验证请求不写入 Elasticsearch（只返回响应）
  if "onenet_verify" not in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logs-%{project}-%{+YYYY.MM.dd}"
      action => "create"
    }
  }

  stdout {
    codec => rubydebug
  }
}

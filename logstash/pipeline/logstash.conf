input {
  # MQTT 输入 - OneNET 物模型主题
  mqtt {
    client_id => "logstash"
    host => "mqtts.heclouds.com"
    port => 1883
    topics => [
      "$sys/v6IkuqD6vh/+/thing/#",
      "$sys/v6IkuqD6vh/+/cmd/#"
    ]
    username => "v6IkuqD6vh"
    password => "version=2018-10-31&res=products%2Fv6IkuqD6vh&et=1772278309&method=sha1&sign=sVo3DxaEUsngKrbsr5Fa0kMAZXI%3D"
    codec => json
    type => "mqtt"
  }

  http {
    port => 5000
    codec => plain
    type => "http"
  }

  tcp {
    port => 5044
    codec => json
    type => "tcp"
  }

  udp {
    port => 5044
    codec => json
    type => "udp"
  }

  file {
    path => "/var/log/docker/*.log"
    start_position => "beginning"
    type => "docker"
  }
}

filter {
  if [type] == "docker" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{GREEDYDATA:message}" }
    }
    date {
      match => [ "timestamp", "ISO8601" ]
    }
  }

  # MQTT 消息处理
  if [type] == "mqtt" {
    mutate {
      add_field => { "project" => "onenet" }
    }
    # 解析 OneNET 物模型主题：$sys/{pid}/{device-name}/{category}/{sub-category}
    if [topic] {
      grok {
        match => {
          "topic" => [
            "\$sys/%{WORD:product_id}/%{WORD:device_name}/%{WORD:category}/%{GREEDYDATA:sub_category}",
            "\$sys/%{WORD:product_id}/%{WORD:device_name}/%{WORD:category}",
            "\$sys/%{WORD:product_id}/%{WORD:device_name}"
          ]
        }
      }
    }
  }

  # 为其他类型添加默认 project 字段
  if [type] == "http" {
    mutate {
      add_field => { "project" => "http" }
    }
  } else if [type] == "tcp" {
    mutate {
      add_field => { "project" => "tcp" }
    }
  } else if [type] == "udp" {
    mutate {
      add_field => { "project" => "udp" }
    }
  } else if ![project] {
    mutate {
      add_field => { "project" => "unknown" }
    }
  }

  # 提取项目信息（保留 Docker 日志逻辑）
  if [path] =~ "zcgames" and [type] == "docker" {
    mutate {
      add_field => { "project" => "zcgames" }
    }
  } else if [path] =~ "edutool" and [type] == "docker" {
    mutate {
      add_field => { "project" => "edutool" }
    }
  } else if [path] =~ "webtool" and [type] == "docker" {
    mutate {
      add_field => { "project" => "webtool" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{project}-%{+YYYY.MM.dd}"
  }

  stdout {
    codec => rubydebug
  }
}
